#!/usr/bin/env python3
"""
BLAST Functional Annotation Script
===================================
Automatically annotates proteins from BLAST XML results.
"""

from Bio.Blast import NCBIXML
from pathlib import Path
import sys


def parse_blast_xml(xml_file):
    """Parse BLAST XML and extract top hits."""
    print(f"Reading file: {xml_file}")
    
    with open(xml_file) as f:
        blast_records = NCBIXML.parse(f)
        results = []
        
        for record in blast_records:
            query_info = {
                'query_id': record.query,
                'query_length': record.query_length,
                'hits': []
            }
            
            for alignment in record.alignments[:10]:
                for hsp in alignment.hsps:
                    hit_info = {
                        'accession': alignment.accession,
                        'hit_def': alignment.hit_def,
                        'length': alignment.length,
                        'e_value': hsp.expect,
                        'score': hsp.score,
                        'bits': hsp.bits,
                        'identity': hsp.identities,
                        'align_length': hsp.align_length,
                        'identity_percent': (hsp.identities / hsp.align_length) * 100
                    }
                    query_info['hits'].append(hit_info)
                    break
                    
            results.append(query_info)
        
        print(f"Found {len(results)} query sequences")
        return results


def identify_protein_family(hit_def):
    """Identify protein family from hit definition."""
    hit_lower = hit_def.lower()
    
    if 'dgtpase' in hit_lower or 'deoxyguanosinetriphosphate' in hit_lower:
        return ('dGTPase', 'Nucleotide metabolism', 'EC 3.6.1.15')
    elif 'kinase' in hit_lower:
        return ('Kinase', 'Phosphorylation', 'EC 2.7.x.x')
    elif 'phosphatase' in hit_lower:
        return ('Phosphatase', 'Dephosphorylation', 'EC 3.1.3.x')
    elif 'transferase' in hit_lower:
        return ('Transferase', 'Group transfer', 'EC 2.x.x.x')
    elif 'hydrolase' in hit_lower:
        return ('Hydrolase', 'Hydrolysis', 'EC 3.x.x.x')
    else:
        return ('Unknown', 'Unknown function', 'N/A')


def get_go_terms(protein_family):
    """Get predicted GO terms based on protein family."""
    if protein_family == 'dGTPase':
        return {
            'molecular_function': [
                'GO:0008828 (dGTPase activity)',
                'GO:0016818 (hydrolase activity)',
                'GO:0046872 (metal ion binding)'
            ],
            'biological_process': [
                'GO:0009143 (nucleoside triphosphate catabolic process)',
                'GO:0006259 (DNA metabolic process)',
                'GO:0006281 (DNA repair)',
                'GO:0006260 (DNA replication)'
            ],
            'cellular_component': [
                'GO:0005737 (cytoplasm)',
                'GO:0005829 (cytosol)'
            ]
        }
    else:
        return {
            'molecular_function': ['GO:0003824 (catalytic activity)'],
            'biological_process': ['GO:0008152 (metabolic process)'],
            'cellular_component': ['GO:0005622 (intracellular)']
        }


def generate_annotation_report(blast_results, output_file):
    """Generate comprehensive annotation report."""
    
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write("=" * 80 + "\n")
        f.write("FUNCTIONAL ANNOTATION REPORT\n")
        f.write("Generated by BLAST Annotation Pipeline\n")
        f.write("=" * 80 + "\n\n")
        
        for result in blast_results:
            query_id = result['query_id']
            query_length = result['query_length']
            hits = result['hits']
            
            if not hits:
                f.write(f"No significant hits found for {query_id}\n\n")
                continue
            
            top_hit = hits[0]
            identity_pct = top_hit['identity_percent']
            e_value = top_hit['e_value']
            
            family, pathway, ec_number = identify_protein_family(top_hit['hit_def'])
            go_terms = get_go_terms(family)
            
            f.write(f"QUERY: {query_id}\n")
            f.write("-" * 80 + "\n")
            f.write(f"Length: {query_length} amino acids\n")
            f.write(f"Top Hit: {top_hit['hit_def'][:70]}...\n")
            f.write(f"Accession: {top_hit['accession']}\n")
            f.write(f"Identity: {identity_pct:.1f}%\n")
            f.write(f"E-value: {e_value:.2e}\n")
            f.write(f"Bit Score: {top_hit['bits']:.1f}\n\n")
            
            f.write("FUNCTIONAL ANNOTATION:\n")
            f.write(f"  Protein Family: {family}\n")
            f.write(f"  Pathway: {pathway}\n")
            f.write(f"  EC Number: {ec_number}\n\n")
            
            f.write("GENE ONTOLOGY (GO) TERMS:\n")
            f.write("  Molecular Function:\n")
            for go in go_terms['molecular_function']:
                f.write(f"    - {go}\n")
            f.write("  Biological Process:\n")
            for go in go_terms['biological_process']:
                f.write(f"    - {go}\n")
            f.write("  Cellular Component:\n")
            for go in go_terms['cellular_component']:
                f.write(f"    - {go}\n")
            f.write("\n")
            
            if identity_pct >= 90 and e_value < 1e-100:
                confidence = "HIGH (Definitive identification)"
            elif identity_pct >= 70:
                confidence = "MEDIUM (Probable homolog)"
            else:
                confidence = "LOW (Distant similarity)"
            
            f.write(f"CONFIDENCE: {confidence}\n")
            f.write("\n" + "=" * 80 + "\n\n")
        
        f.write("SUMMARY STATISTICS\n")
        f.write("=" * 80 + "\n")
        f.write(f"Total queries analyzed: {len(blast_results)}\n")
        f.write(f"Queries with hits: {sum(1 for r in blast_results if r['hits'])}\n")
        f.write("\n")
        
        organisms = {}
        for result in blast_results:
            for hit in result['hits'][:3]:
                desc = hit['hit_def']
                if '[' in desc and ']' in desc:
                    org = desc[desc.find('[')+1:desc.find(']')]
                    organisms[org] = organisms.get(org, 0) + 1
        
        if organisms:
            f.write("TOP ORGANISMS:\n")
            for org, count in sorted(organisms.items(), key=lambda x: x[1], reverse=True)[:5]:
                f.write(f"  - {org}: {count} hits\n")
        
        f.write("\n" + "=" * 80 + "\n")
        f.write("End of Report\n")


def main():
    print("=" * 60)
    print("BLAST FUNCTIONAL ANNOTATION")
    print("=" * 60)
    
    # ============================================
    # EDIT THESE PATHS FOR YOUR SYSTEM
    # ============================================
    
    # Use forward slashes OR raw strings (r"...")
    xml_file = "D:/Project Biopyhton By Muhammad Ali/data/blastp_result.xml"
    output_file = "D:/Project Biopyhton By Muhammad Ali/annotation_report.txt"
    
    # ============================================
    
    print(f"\nInput file: {xml_file}")
    print(f"Output file: {output_file}\n")
    
    # Check if file exists
    if not Path(xml_file).exists():
        print(f"ERROR: File not found: {xml_file}")
        print("\nTroubleshooting:")
        print("1. Check if the file exists")
        print("2. Verify the path is correct")
        print("3. Try using the full path")
        return
    
    try:
        # Parse BLAST results
        print("Step 1: Parsing BLAST XML...")
        blast_results = parse_blast_xml(xml_file)
        
        if not blast_results:
            print("No results found in XML file!")
            return
        
        # Generate report
        print("\nStep 2: Generating annotation report...")
        generate_annotation_report(blast_results, output_file)
        
        print(f"\n[OK] Success! Report saved to: {output_file}")
        
        # Print summary
        print("\n" + "=" * 60)
        print("ANNOTATION SUMMARY")
        print("=" * 60)
        for result in blast_results:
            if result['hits']:
                top = result['hits'][0]
                family = identify_protein_family(top['hit_def'])[0]
                print(f"\nQuery: {result['query_id']}")
                print(f"  Protein: {top['hit_def'][:50]}...")
                print(f"  Identity: {top['identity_percent']:.1f}%")
                print(f"  E-value: {top['e_value']:.2e}")
                print(f"  Family: {family}")
        
        print("\n" + "=" * 60)
        
    except Exception as e:
        print(f"\n[ERROR] {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()
    # ============================================
    # HARDCODED PATHS - Edit these for your system
    # ============================================
    
    # Use 'r' before the string to handle backslashes correctly!
    xml_file = r"D:\Project Biopyhton By Muhammad Ali\data\blastp_result.xml"
    output_file = r"D:\Project Biopyhton By Muhammad Ali\annotation_report.txt"
    
    # ============================================
    # COMMENT OUT OR DELETE THESE LINES:
    if len(sys.argv) < 2:
        print("Usage: python annotation.py <blast_xml_file> [output.txt]")
        print("Example: python annotation.py blastp_result.xml annotation_report.txt")
        sys.exit(1)
     
        xml_file = sys.argv[1]
        output_file = sys.argv[2] if len(sys.argv) > 2 else "annotation_report.txt"
    # ============================================
    
    print(f"Input file: {xml_file}")
    print(f"Output file: {output_file}")
    print("-" * 60)
    
    if not Path(xml_file).exists():
        print(f"ERROR: File not found: {xml_file}")
        print("Please check the path and try again.")
        sys.exit(1)
    
    print("Parsing BLAST results...")
    blast_results = parse_blast_xml(xml_file)
    
    print("Generating annotation report...")
    generate_annotation_report(blast_results, output_file)
    
    print(f"[OK] Done! Report saved to: {output_file}")
    
    # Print summary
    print("\n" + "=" * 60)
    print("ANNOTATION SUMMARY")
    print("=" * 60)
    for result in blast_results:
        if result['hits']:
            top = result['hits'][0]
            print(f"\nQuery: {result['query_id']}")
            print(f"  Protein: {top['hit_def'][:50]}...")
            print(f"  Identity: {top['identity_percent']:.1f}%")
            print(f"  E-value: {top['e_value']:.2e}")